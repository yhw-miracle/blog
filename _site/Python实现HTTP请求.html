<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Python实现HTTP请求</title>

  <link rel="stylesheet" href="/assets/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Python实现HTTP请求 | yhw-miracle’s Blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Python实现HTTP请求" />
<meta name="author" content="yhw-miracle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="python　中实现 HTTP 请求有三种方式，分别为 urllib2/urllib、httplib/urllib 和 Requests。" />
<meta property="og:description" content="python　中实现 HTTP 请求有三种方式，分别为 urllib2/urllib、httplib/urllib 和 Requests。" />
<link rel="canonical" href="http://localhost:4000/Python%E5%AE%9E%E7%8E%B0HTTP%E8%AF%B7%E6%B1%82" />
<meta property="og:url" content="http://localhost:4000/Python%E5%AE%9E%E7%8E%B0HTTP%E8%AF%B7%E6%B1%82" />
<meta property="og:site_name" content="yhw-miracle’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-06T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"python　中实现 HTTP 请求有三种方式，分别为 urllib2/urllib、httplib/urllib 和 Requests。","author":{"@type":"Person","name":"yhw-miracle"},"@type":"BlogPosting","url":"http://localhost:4000/Python%E5%AE%9E%E7%8E%B0HTTP%E8%AF%B7%E6%B1%82","headline":"Python实现HTTP请求","dateModified":"2018-08-06T00:00:00+08:00","datePublished":"2018-08-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Python%E5%AE%9E%E7%8E%B0HTTP%E8%AF%B7%E6%B1%82"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>YHW-MIRACLE</h1>
    </a>
    <div class="header-links">
      <a href="/all_posts">
    <h2 class="header-link">All_Posts | </h2>
</a>
<a href="/about">
    <h2 class="header-link">About | </h2>
</a>
<a href="/categories">
    <h2 class="header-link">Categories | </h2>
</a>
<a href="/tags">
    <h2 class="header-link">Tags</h2>
</a>
<!--<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>-->

    </div>
  </div>
</header>

    <div class="container">
      <section id="main_content">
        <article>
  <h2 align="center">Python实现HTTP请求</h2>
  <img src="/images/authorize.png" />
  <center>
    yhw-miracle writed in <time datetime="2018-08-06T00:00:00+08:00" class="by-line">August 6th, 2018</time>
  </center>
  <p>python　中实现 HTTP 请求有三种方式，分别为 urllib2/urllib、httplib/urllib 和 Requests。</p>

<h3 id="1-urllib2urllib">1. urllib2/urllib</h3>
<h4 id="11-基本请求和响应模型">1.1 基本请求和响应模型</h4>
<p>urllib2 和 urllib 是 Python 中的两个内置模块，实现 HTTP 请求时，以 urllib2 为主，urllib　为辅。urllib2 模块提供了 urliopen() 方法，可以向指定的 URL 发出请求来获取数据。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="c1"># 请求
</span><span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>

<span class="c1"># 响应
</span><span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="12-请求头-headers-处理">1.2 请求头 headers 处理</h4>
<p>请求头信息可以直接与 URL 一起放到 Requset() 方法里，也可以使用 add_header() 方法添加请求头信息。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">"https://github.com/login"</span>
<span class="n">userAgent</span> <span class="o">=</span> <span class="s">'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'</span>
<span class="n">referer</span> <span class="o">=</span> <span class="s">'https://github.com'</span>
<span class="n">postData</span> <span class="o">=</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="s">'111'</span><span class="p">,</span> <span class="s">'passowrd'</span><span class="p">:</span> <span class="s">'222'</span><span class="p">}</span>

<span class="c1"># 将 userAgent, referer 写入头信息
</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'User-Agent'</span><span class="p">:</span> <span class="n">userAgent</span><span class="p">,</span> <span class="s">'Referer'</span><span class="p">:</span> <span class="n">referer</span><span class="p">}</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">postData</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
<span class="c1"># request.add_header('User-Agent', userAgent)
# request.add_header('Referer', referer)
</span><span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="13-cookie-处理">1.3 Cookie 处理</h4>
<p>urllib2 对 Cookie 的处理是自动的，使用 CookieJar 函数进行 Cookie 的管理。我们也可以通过设置请求头中的 Cookie 域来自定义添加 Cookie 的内容。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">cookielib</span>

<span class="n">cookie</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">CookieJar</span><span class="p">()</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPCookieProcessor</span><span class="p">(</span><span class="n">cookie</span><span class="p">))</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cookie</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">':'</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">cookielib</span>

<span class="n">cookie</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">CookieJar</span><span class="p">()</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">()</span>
<span class="n">opener</span><span class="o">.</span><span class="n">addheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">'cookie'</span><span class="p">,</span> <span class="s">'email='</span><span class="o">+</span><span class="s">"xxx@163.com"</span><span class="p">))</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="14-设置超时处理的三种方法">1.4 设置超时处理的三种方法</h4>
<p>在 python2.6 之前的版本，urllib2 的 API 并没有 Timeout 的设置，要设置 Timeout 值，只能通过设置 Socket 的全局 Timeout 值实现。而在 python2.6 及新的版本中，urlopen() 函数提供了对 Timeout 的设置。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="c1"># way 1
</span><span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># way 2
</span><span class="n">urllib2</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># way 3
</span><span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="15-获取-http-响应码">1.5 获取 HTTP 响应码</h4>
<p>对于 200 OK 来说，urlopen() 方法返回的 response 对象的 getcode() 方法可以得到该 HTTP 响应码，但是对于其他类型的响应码，urlopen() 方法会抛出异常，这样需要通过异常对象来获取响应码。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">getcode</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://www.google.com'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">response</span>
<span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">'code'</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">'Error code:'</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>
</code></pre></div></div>

<h4 id="16-重定向">1.6 重定向</h4>
<p>urllib2 默认情况下会针对 HTTP 3XX 返回码自动进行重定向动作。要检测是否发生了重定向动作，只要检查一些 Response 的 URL 和 Resquest 的 URL 是否一致就可以了。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://www.zhihu.com'</span><span class="p">)</span>
<span class="n">isRedirected</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span> <span class="o">==</span> <span class="s">'http://www.zhihu.com'</span>
<span class="k">print</span> <span class="n">isRedirected</span>
</code></pre></div></div>

<p>如果不想自动重定向，可以自定义 HTTPRedirectHandler 类实现。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>


<span class="k">class</span> <span class="nc">RedirectHandler</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPRedirectHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">http_error_301</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">http_error_302</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPRedirectHandler</span><span class="o">.</span><span class="n">http_error_301</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">result</span><span class="o">.</span><span class="n">newurl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">RedirectHandler</span><span class="p">)</span>
<span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://www.zhihu.com'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="17-proxy-代理">1.7 Proxy 代理</h4>
<p>urllib2 默认使用环境变量 http_proxy 来设置 HTTP Proxy；也可以使用 ProxyHandler 在程序中动态设置代理。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">({</span><span class="s">'http'</span><span class="p">:</span> <span class="s">'127.0.0.1:8087'</span><span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">([</span><span class="n">proxy</span><span class="p">,</span> <span class="p">])</span>
<span class="n">urllib2</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">'http://www.zhihu.com'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<p>使用 urllib2.install_opener() 方法会全局设置代理，不利于更细粒度的控制，可以使用 opener.open() 代替全局的 urlopen()　方法使用不同的代理。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">proxy</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">({</span><span class="s">'http'</span><span class="p">:</span> <span class="s">'127.0.0.1:8087'</span><span class="p">})</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'http://www.zhihu.com'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="2-httpliburllib">2. httplib/urllib</h3>
<p>httplib 模块是一个底层基础模块，可以了解建立 HTTP 请求的每一步，正常情况下开发用的很少。</p>

<table>
  <thead>
    <tr>
      <th>功能</th>
      <th>API</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>创建 HTTPConnection 对象</td>
      <td>httplib.HTTPConnection(host[.port,[strict[,timeout[,source_address]]]])</td>
    </tr>
    <tr>
      <td>发送请求</td>
      <td>HTTPConnection.request(method,url[,body[,headers]])</td>
    </tr>
    <tr>
      <td>获得响应</td>
      <td>HTTPConnection.getresponse()</td>
    </tr>
    <tr>
      <td>读取响应信息</td>
      <td>HTTPResponse.read()</td>
    </tr>
    <tr>
      <td>获取指定请求头信息</td>
      <td>HTTPResponse.getheader(name[,default])</td>
    </tr>
    <tr>
      <td>获取响应头，以 (header, value) 元组构成的列表返回</td>
      <td>HTTPResponse.getheaders()</td>
    </tr>
    <tr>
      <td>获取底层 socket 文件描述符</td>
      <td>HTTPResponse.fileno()</td>
    </tr>
    <tr>
      <td>获取头内容</td>
      <td>HTTPResponse.msg</td>
    </tr>
    <tr>
      <td>获取头 http 版本</td>
      <td>HTTPResponse.version</td>
    </tr>
    <tr>
      <td>获取返回状态码</td>
      <td>HTTPResponse.status</td>
    </tr>
    <tr>
      <td>获取返回说明</td>
      <td>HTTPResponse.reason</td>
    </tr>
  </tbody>
</table>

<h3 id="3-requests">3. Requests</h3>
<h4 id="31-requests-安装">3.1 Requests 安装</h4>
<p>Python 中 Requests 模块实现 HTTP　请求的方式非常简单，操作更加人性化。Requests 库是第三方模块，需要额外安装，其源码开源，位于 <a href="https://github.com/requests/requests">Github</a> 上。安装 requests 方式有两种：</p>

<blockquote>
  <ol>
    <li>直接在 Terminal 上输入命令 pip install requests</li>
    <li>下载 <a href="https://github.com/requests/requests/releases">requests 源码</a>，然后解压，在 Terminal 中进入解压后的目录，运行 setup.py 文件即可。</li>
  </ol>
</blockquote>

<h4 id="32-基本请求和响应模型">3.2 基本请求和响应模型</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># get 请求
</span><span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># post 请求
</span><span class="n">postData</span> <span class="o">=</span> <span class="p">{</span><span class="s">'key'</span><span class="p">:</span> <span class="s">'value'</span><span class="p">}</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://www.xxx.com/login'</span><span class="p">,</span> <span class="n">postData</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

<span class="c1"># https://zzk.cnblogs.com/s/blogpost?Keywords=blog:qiyeboy&amp;pageindex=1
# 处理 ? 后面的参数
</span><span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Keywords'</span><span class="p">:</span> <span class="s">'blog:qiyeboy'</span><span class="p">,</span> <span class="s">'pageindex'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://zzk.cnblogs.com/s/blogpost'</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="33-响应码-code-和请求头-headers-处理">3.3 响应码 code 和请求头 headers 处理</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>   <span class="c1"># 响应码
</span>    <span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>   <span class="c1"># 响应头
</span>    <span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'content-type'</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'content-type'</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">req</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="34-cookie-处理">3.4 Cookie 处理</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">userAgent</span> <span class="o">=</span> <span class="s">'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'User-Agent'</span><span class="p">:</span> <span class="n">userAgent</span><span class="p">}</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">cookie</span> <span class="o">+</span> <span class="s">':'</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cookie</span><span class="p">))</span>

<span class="n">userAgent</span> <span class="o">=</span> <span class="s">'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'User-Agent'</span><span class="p">:</span> <span class="n">userAgent</span><span class="p">}</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'qiye'</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="s">'10'</span><span class="p">)</span>
<span class="c1"># 发送 cookie
</span><span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://www.baidu.com'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

<span class="n">loginUrl</span> <span class="o">=</span> <span class="s">'http://www.xxx.com/login'</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="c1"># 首先访问登录页面，作为游客，服务器会先分配一个 cookie
</span><span class="n">req</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loginUrl</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">datas</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'qiye'</span><span class="p">,</span> <span class="s">'passwd'</span><span class="p">:</span> <span class="s">'qiye'</span><span class="p">}</span>
<span class="c1"># 向登录链接发送 post 请求，验证成功，游客权限转为会员权限
</span><span class="n">req</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">loginUrl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">datas</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="35-重定向与历史信息">3.5 重定向与历史信息</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># allow_redirects=True 允许重定向，默认允许
# requests.get('', allow_redirects=True)
</span><span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://github.com'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="36-超时设置">3.6 超时设置</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">print</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://www.google.com'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="37-代理设置">3.7 代理设置</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"http"</span><span class="p">:</span> <span class="s">"http://0.10.1.10:3128"</span><span class="p">,</span>
    <span class="s">"https"</span><span class="p">:</span> <span class="s">"http://10.10.1.10:1080"</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://example.org'</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
</code></pre></div></div>


</article>


	<div class="tags">
	<img src="/images/tag.png" />
	
		<a href="/tag/python">python</a>
	
		<a href="/tag/HTTP">HTTP</a>
	
		<a href="/tag/request">request</a>
	
		<a href="/tag/response">response</a>
	
	</div>






	<div class="categories">
	<img src="/images/category.png" />
	
	  <a href="/category/知识总结">知识总结</a>
	
	</div>




<div class="pagination">
    上一篇：
    
      <a href="/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" class="previous">
        <img src="/images/previous.png" />
      </a>
    
  
    | 下一篇：
    
      <a href="/%E5%AD%A6%E4%B8%80%E7%82%B9XPath" class="next">
        <img src="/images/next.png" />
      </a>
    
  </div>


      </section>
    </div>
  </div>

  

  <div align="center" id="qecode_img">
  <hr />
  <p>欢迎关注，我们一起进行认知迭代！</p>
  <img src="/images/qrcode_for_gh_5efb2780ab44_258.jpg" /><br />
  痛点就是起点
</div>

<footer>
  <!-- <a href="https://blogs.yhw-miracle.cn">
    <span>
        <b>yhw-miracle</b>
    </span>
    
    <span>© 2016 - 2019</span>
  </a> -->
</footer>

<div align="center" style="font-size: 13px;">
  <hr />
  <span>&copy; 2016 - 2019</span>基于
  <a href="https://jekyllrb.com">jekyll</a> | 
  <a href="https://github.com">Github Pags</a> | 
  By <a href="blogs.yhw-miracle.cn">yhw-miracle</a>
</div>


  <!--  -->
</body>
</html>